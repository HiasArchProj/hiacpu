# HIACPU (Higher CPU)

**HIACPU** is a RISC-V 32-bit, five-stage pipelined, dual-issue, in-order CPU implemented using the Chisel hardware description language. This project originated from the [chisel-nix](https://github.com/chipsalliance/chisel-nix) template flake and aims to provide a high-performance and extensible CPU core suitable for educational and experimental purposes.

## Features

- **RISC-V 32-bit Architecture**: Implements a RISC-V RV32IM instruction set architecture with dual-issue capability.
- **Five-Stage Pipeline**: Includes Fetch, Decode, Execute, Memory, and Writeback stages.
- **Dual-Issue Execution**: Supports issuing two instructions simultaneously, improving instruction throughput.
- **In-Order Execution**: Simple and predictable execution model, suitable for understanding the fundamentals of CPU design.
- **Nix Build Flow**: Uses the Nix package manager to provide a reproducible and isolated development environment.
- **Separation of Driver and Test**: Adopts a verification strategy that separates the CPU's drivers from its test cases, facilitating easier and more structured testing.
- **Formal Verification**: Plans to utilize formal verification tools like JasperGold to ensure the correctness of the CPU design.
- **RTL Code Generation**: Capable of generating RTL code that can be synthesized for implementation on FPGAs or ASICs.
- **Complete C Software Stack**: Includes a complete C software stack, allowing you to compile and run programs on the CPU.
- **Support for Educational Use**: Can be used to run RISC-V 32 code generated by compilers from an advanced compiler principles course.

## TODOs:

- [ ] design the cpu
- [ ] add difftest framework support
- [ ] add formal verification
- [ ] add C software stack

## Installation

First, make sure you have nix installed on your system: `nix --version`. If not, you can install it according to [nix-download](https://nixos.org/download/).

Next, clone the repository and navigate to the project directory:

```bash
git clone https://github.com/chipsalliance/chisel-nix
```

You should have a glance at the [chisel-nix](https://github.com/chipsalliance/chisel-nix) project, the build flow and cpu design flow are based on it. 

## Flows
### attribute
- hia-compiled: JVM bytecode for the hia and elaborator
- elaborator: a bash wrapper for running the elaborator with JDK
- elaborate: Unlowered MLIR bytecode output from firrtl elaborated by elaborator
- mlirbc: MLIR bytecode lowered by circt framework
- rtl: system verilog generated from the lowered MLIR bytecode
- verilated-c-lib: C library verilated from system verilog
- To get the corresponding output, developers can use:

### build flow
To get the corresponding output, developers can use:

```bash
nix build .#hia.<attr>
```

For example, to get the final lowered system verilog, developer can run:

```bash
nix build .#hia.rtl
```

For example, to get the verification-based verilog, developer can run:

```bash
nix build .#hia.tb-rtl
```

The build result will be a symlink to nix store placed under the ./result.

### develop flow
To have same environment as the build script for developing purpose, developer can use:

```bash
nix develop .#hia.<attr>
```
For example, to modify the hia sources, developer can run:

```bash
nix develop .#hia.hia-compiled
```

The above command will provide a new bash shell with mill, circt, chisel... dependencies set up.

### running flow

build riscv-tests:

```bash
nix build .#riscv-tests
```

run the test cases

```bash
nix run .#hia.verilated-trace -- +elf-file=$(nix build --no-link --print-out-paths .#riscv-tests)/riscv32-unknown-elf/share/riscv-tests/isa/rv32ui-p-add +dump-start=0 +dump-end=10000 +wave-path=/tmp/wave.fst
```



## LSP configuration

wip. 
Please look at the doc/add_direnv_support_for_chisel-nix(_cn).md for more information.

## License

This project's nix build flow is licensed under the Apache License 2.0
This project's CPU design flow is licensed under the MIT License
